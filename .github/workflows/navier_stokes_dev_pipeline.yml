name: Navierâ€“Stokes Solver Development Pipeline

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  integrated_dev_flow:
    runs-on: ubuntu-latest

    # Global environment to ensure all src modules are resolvable
    env:
      PYTHONPATH: ${{ github.workspace }}
      APP_KEY: ${{ secrets.APP_KEY }}
      APP_SECRET: ${{ secrets.APP_SECRET }}
      REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}

    steps:
      - name: ðŸ—‚ï¸ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Install Core Dependencies
        run: |
          python -m pip install --upgrade pip
          # Ensure 'dropbox' and 'requests' are included for the IO bridge
          pip install -r requirements.txt pytest coverage numpy autoflake vulture dropbox requests

      - name: ðŸ§¹ Auto-Clean (Autoflake)
        run: |
          autoflake --in-place --recursive --remove-unused-variables --remove-all-unused-imports src

      - name: ðŸš€ Commit & Push Auto-Clean Changes
        env:
          GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
          GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
        run: |
          git config --global user.name "${GIT_USER_NAME:-'github-actions[bot]'}"
          git config --global user.email "${GIT_USER_EMAIL:-'github-actions[bot]@users.noreply.github.com'}"
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ðŸ§¹ Auto-clean: removed unused imports and variables"
            git push
          else
            echo "No cleaning required."
          fi

      - name: ðŸ’€ Dead Code Audit (Vulture)
        run: |
          vulture src --min-confidence 70

      - name: ðŸ§ª Run Unit Tests (Pytest + Coverage)
        run: |
          echo "ðŸ” Running unit tests..."
          pytest tests/ -vv --cov=src --cov-report=term-missing

      # # --- POINT 1: CLOUD INGESTION ---
      # - name: ðŸ“¥ Ingest Simulation Input (Dropbox)
      #   run: |
      #     chmod +x src/download_from_dropbox.sh
      #     bash src/download_from_dropbox.sh

      # # --- POINT 2: PHYSICS EXECUTION ---
      # - name: ðŸš€ Run Navier-Stokes Solver
      #   id: solver_run
      #   run: |
      #     # We execute the solver and capture its STDOUT (the path to the ZIP)
      #     # Note: Errors and logs are sent to STDERR so they don't corrupt the variable
      #     ZIP_PATH=$(python3 src/main_solver.py data/testing-input-output/fluid_simulation_input.json)
          
      #     # Pass the dynamic path to the GitHub Environment for the next step
      #     echo "SOLVER_ZIP_RESULT=$ZIP_PATH" >> $GITHUB_ENV
      #     echo "âœ… Solver completed. Output Path: $ZIP_PATH"

      # # --- POINT 3: CLOUD EXPORT ---
      # - name: ðŸ“¤ Export Simulation Results (Dropbox)
      #   if: success()
      #   run: |
      #     chmod +x src/upload_to_dropbox.sh
      #     # Pass the captured ZIP path as the first argument
      #     bash src/upload_to_dropbox.sh "${{ env.SOLVER_ZIP_RESULT }}"

      # - name: ðŸ“¦ Final Structure Audit
      #   run: |
      #     echo "ðŸ“ Final Workspace State:"
      #     ls -R

      - name: ðŸ“Š Audit Performance & Update Ledger
        if: always() # Run even if previous steps failed
        env:
          GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
          GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
        run: |
          # 1. Gather Metrics
          RUN_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          STATUS="${{ job.status }}"
          
          # Calculate Duration (Workflow start time is a default GH variable)
          # Note: Simple duration calculation in seconds
          NOW=$(date +%s)
          START_TIME=$(date -d "${{ github.event.repository.pushed_at }}" +%s 2>/dev/null || echo $NOW)
          DURATION_SEC=$((NOW - START_TIME))
          
          # Resource Usage (Current snapshot of the runner)
          CPU_LOAD=$(top -bn1 | grep "Cpu(s)" | awk '{print $2 + $4}')
          MEM_USAGE=$(free -m | awk '/Mem:/ { print $3 "/" $2 "MB (" $3/$2*100 "% )" }')
          
          # Identify Failure Step if applicable
          FAILURE_POINT="N/A (Success)"
          if [ "$STATUS" != "success" ]; then
             FAILURE_POINT="Check GitHub Logs"
          fi

          # 2. Append to Performance Audit Ledger
          # We use a Table format for readability
          echo "| $RUN_DATE | $STATUS | ${DURATION_SEC}s | $CPU_LOAD% | $MEM_USAGE | $FAILURE_POINT |" >> performance_audit.md
          
          # 3. Commit and Push the updated Ledger
          git config --global user.name "${GIT_USER_NAME:-'github-actions[bot]'}"
          git config --global user.email "${GIT_USER_EMAIL:-'github-actions[bot]@users.noreply.github.com'}"
          git add performance_audit.md
          git commit -m "ðŸ“Š perf-audit: log run metrics for $RUN_DATE"
          git push origin main || echo "No changes to push or branch protected"