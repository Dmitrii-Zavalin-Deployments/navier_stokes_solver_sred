name: Navierâ€“Stokes Solver Development Pipeline

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  integrated_dev_flow:
    runs-on: ubuntu-latest

    env:
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: ğŸ—‚ï¸ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Core Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest coverage numpy autoflake vulture

      - name: ğŸ§¹ Auto-Clean (Autoflake)
        run: |
          autoflake --in-place --recursive --remove-unused-variables --remove-all-unused-imports src

      - name: ğŸš€ Commit & Push Auto-Clean Changes
        env:
          GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
          GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
        run: |
          git config --global user.name "${GIT_USER_NAME:-'github-actions[bot]'}"
          git config --global user.email "${GIT_USER_EMAIL:-'github-actions[bot]@users.noreply.github.com'}"
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ğŸ§¹ Auto-clean: removed unused imports and variables"
            git push
          else
            echo "No cleaning required."
          fi

      - name: ğŸ’€ Dead Code Audit (Vulture)
        run: |
          vulture src --min-confidence 70

      - name: ğŸ§¬ Duplicate Code Audit (JSCPD)
        run: |
          npm install -g jscpd
          jscpd src --min-lines 5 --threshold 5 --reporters console

      - name: ğŸ§ª Run Unit Tests (Pytest + Coverage)
        run: |
          echo "ğŸ” Running unit tests..."
          # Added -vv for deep inspection of contract failures
          pytest tests/ -vv --verbose --cov=src --cov-report=term-missing
          echo "âœ… Unit tests completed."

      # ---------------------------------------------------------
      # âŒ REAL SOLVER EXECUTION DISABLED DURING DEVELOPMENT
      # ---------------------------------------------------------
      - name: ğŸš€ Run Main Solver (DISABLED)
        run: |
          echo "âš ï¸ Solver execution disabled during development phase."
          # python core/master_solver.py input.json
      # ---------------------------------------------------------

      - name: ğŸ“¦ Final Structure Audit
        run: |
          echo "ğŸ“ Repository structure after pipeline:"
          ls -R