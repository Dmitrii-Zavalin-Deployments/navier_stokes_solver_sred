{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Step 3 Output Schema",
  "type": "object",

  "required": [
    "config",
    "mask",
    "is_fluid",
    "is_boundary_cell",
    "fields",
    "bcs",
    "constants",
    "operators",
    "ppe",
    "health",
    "history"
  ],

  "properties": {

    "config": {
      "type": "object",
      "description": "Simulation configuration (unchanged from Step 1)."
    },

    "mask": {
      "type": "array",
      "description": "Geometry mask (1=fluid, 0=solid, -1=boundary-fluid)."
    },

    "is_fluid": {
      "type": "array",
      "description": "Boolean mask of fluid cells."
    },

    "is_boundary_cell": {
      "type": "array",
      "description": "Boolean mask of boundary-adjacent cells."
    },

    "fields": {
      "type": "object",
      "required": ["P", "U", "V", "W"],
      "properties": {
        "P": {
          "type": "array",
          "description": "Updated pressure field (cell-centered)."
        },
        "U": {
          "type": "array",
          "description": "Updated x-face velocity field."
        },
        "V": {
          "type": "array",
          "description": "Updated y-face velocity field."
        },
        "W": {
          "type": "array",
          "description": "Updated z-face velocity field."
        }
      }
    },

    "bcs": {
      "type": "array",
      "description": "Normalized boundary condition table."
    },

    "constants": {
      "type": "object",
      "description": "Physical and numerical constants (unchanged from Step 2)."
    },

    "operators": {
      "type": "object",
      "description": "Discrete operators (Python callables; replaced with placeholders during JSON validation).",
      "properties": {
        "divergence": { "type": "object" },
        "gradient_p_x": { "type": "object" },
        "gradient_p_y": { "type": "object" },
        "gradient_p_z": { "type": "object" },
        "laplacian_u": { "type": "object" },
        "laplacian_v": { "type": "object" },
        "laplacian_w": { "type": "object" },
        "advection_u": { "type": "object" },
        "advection_v": { "type": "object" },
        "advection_w": { "type": "object" }
      }
    },

    "ppe": {
      "type": "object",
      "description": "Pressure Poisson Equation metadata.",
      "properties": {
        "rhs_builder": { "type": "object" },
        "solver_type": { "type": ["string", "null"] },
        "tolerance": { "type": ["number", "null"] },
        "max_iterations": { "type": ["integer", "null"] },
        "ppe_is_singular": { "type": "boolean" },
        "ppe_converged": {
          "type": "boolean",
          "description": "True if PPE solver reached tolerance before max_iterations."
        }
      },
      "required": ["ppe_is_singular"]
    },

    "health": {
      "type": "object",
      "description": "Updated diagnostics after the projection step.",
      "properties": {
        "post_correction_divergence_norm": {
          "type": "number",
          "description": "Divergence norm after velocity correction."
        },
        "max_velocity_magnitude": { "type": "number" },
        "cfl_advection_estimate": { "type": "number" }
      },
      "required": [
        "post_correction_divergence_norm",
        "max_velocity_magnitude",
        "cfl_advection_estimate"
      ]
    },

    "advection_meta": {
      "type": ["object", "null"],
      "description": "Metadata for advection (unchanged from Step 2)."
    },

    "history": {
      "type": "object",
      "description": "Time-series history appended during time stepping.",
      "properties": {
        "times": { "type": "array" },
        "divergence_norms": { "type": "array" },
        "max_velocity_history": { "type": "array" },
        "ppe_iterations_history": { "type": "array" },
        "energy_history": {
          "type": "array",
          "description": "Total kinetic energy per time step."
        }
      }
    }
  }
}