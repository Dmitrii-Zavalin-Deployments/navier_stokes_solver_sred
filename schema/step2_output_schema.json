{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Step 2 Output Schema",
  "type": "object",

  "required": [
    "grid",
    "fields",
    "mask",
    "constants",
    "config",
    "operators",
    "ppe",
    "health",
    "is_fluid",
    "is_boundary_cell"
  ],

  "properties": {

    "grid": {
      "type": "object",
      "required": [
        "x_min", "x_max",
        "y_min", "y_max",
        "z_min", "z_max",
        "nx", "ny", "nz",
        "dx", "dy", "dz"
      ],
      "properties": {
        "x_min": { "type": "number" },
        "x_max": { "type": "number" },
        "y_min": { "type": "number" },
        "y_max": { "type": "number" },
        "z_min": { "type": "number" },
        "z_max": { "type": "number" },

        "nx": { "type": "integer", "minimum": 1 },
        "ny": { "type": "integer", "minimum": 1 },
        "nz": { "type": "integer", "minimum": 1 },

        "dx": { "type": "number", "exclusiveMinimum": 0 },
        "dy": { "type": "number", "exclusiveMinimum": 0 },
        "dz": { "type": "number", "exclusiveMinimum": 0 }
      }
    },

    "fields": {
      "type": "object",
      "required": ["P", "U", "V", "W"],
      "properties": {
        "P": {
          "type": ["array", "object"],
          "items": {
            "type": "array",
            "items": {
              "type": "array",
              "items": { "type": "number" }
            }
          },
          "description": "3D pressure field; Python list or NumPy ndarray."
        },
        "U": {
          "type": ["array", "object"],
          "items": {
            "type": "array",
            "items": {
              "type": "array",
              "items": { "type": "number" }
            }
          },
          "description": "3D x-velocity field; Python list or NumPy ndarray."
        },
        "V": {
          "type": ["array", "object"],
          "items": {
            "type": "array",
            "items": {
              "type": "array",
              "items": { "type": "number" }
            }
          },
          "description": "3D y-velocity field; Python list or NumPy ndarray."
        },
        "W": {
          "type": ["array", "object"],
          "items": {
            "type": "array",
            "items": {
              "type": "array",
              "items": { "type": "number" }
            }
          },
          "description": "3D z-velocity field; Python list or NumPy ndarray."
        }
      }
    },

    "mask": {
      "type": ["array", "object"],
      "items": {
        "type": "array",
        "items": {
          "type": "array",
          "items": {
            "type": "integer",
            "enum": [-1, 0, 1]
          }
        }
      },
      "description": "3D cell-type mask; Python list or NumPy ndarray."
    },

    "is_fluid": {
      "type": ["array", "object"],
      "items": {
        "type": "array",
        "items": {
          "type": "array",
          "items": { "type": "boolean" }
        }
      },
      "description": "3D boolean fluid mask; Python list or NumPy ndarray."
    },

    "is_boundary_cell": {
      "type": ["array", "object"],
      "items": {
        "type": "array",
        "items": {
          "type": "array",
          "items": { "type": "boolean" }
        }
      },
      "description": "3D boolean boundary-fluid mask; Python list or NumPy ndarray."
    },

    "constants": {
      "type": "object",
      "required": [
        "rho", "mu", "dt",
        "dx", "dy", "dz",
        "inv_dx", "inv_dy", "inv_dz",
        "inv_dx2", "inv_dy2", "inv_dz2"
      ],
      "properties": {
        "rho": { "type": "number", "exclusiveMinimum": 0 },
        "mu": { "type": "number", "minimum": 0 },
        "dt": { "type": "number", "exclusiveMinimum": 0 },

        "dx": { "type": "number", "exclusiveMinimum": 0 },
        "dy": { "type": "number", "exclusiveMinimum": 0 },
        "dz": { "type": "number", "exclusiveMinimum": 0 },

        "inv_dx": { "type": "number" },
        "inv_dy": { "type": "number" },
        "inv_dz": { "type": "number" },

        "inv_dx2": { "type": "number" },
        "inv_dy2": { "type": "number" },
        "inv_dz2": { "type": "number" }
      }
    },

    "operators": {
      "type": "object",
      "required": [
        "divergence",
        "gradient_p_x", "gradient_p_y", "gradient_p_z",
        "laplacian_u", "laplacian_v", "laplacian_w",
        "advection_u", "advection_v", "advection_w"
      ],
      "properties": {
        "divergence": { "type": "string" },
        "gradient_p_x": { "type": "string" },
        "gradient_p_y": { "type": "string" },
        "gradient_p_z": { "type": "string" },

        "laplacian_u": { "type": "string" },
        "laplacian_v": { "type": "string" },
        "laplacian_w": { "type": "string" },

        "advection_u": { "type": "string" },
        "advection_v": { "type": "string" },
        "advection_w": { "type": "string" },

        "interpolation_stencils": {
          "type": ["string", "null"],
          "description": "Optional precomputed interpolation maps."
        }
      }
    },

    "ppe": {
      "type": "object",
      "required": [
        "rhs_builder",
        "solver_type",
        "tolerance",
        "max_iterations",
        "ppe_is_singular"
      ],
      "properties": {
        "rhs_builder": { "type": "string" },
        "solver_type": { "type": "string" },
        "tolerance": { "type": "number", "minimum": 0 },
        "max_iterations": { "type": "integer", "minimum": 1 },
        "ppe_is_singular": { "type": "boolean" }
      }
    },

    "health": {
      "type": "object",
      "required": [
        "initial_divergence_norm",
        "max_velocity_magnitude",
        "cfl_advection_estimate"
      ],
      "properties": {
        "initial_divergence_norm": { "type": "number", "minimum": 0 },
        "max_velocity_magnitude": { "type": "number", "minimum": 0 },
        "cfl_advection_estimate": { "type": "number", "minimum": 0 }
      }
    },

    "config": {
      "type": "object",
      "description": "Original validated input JSON passed through unchanged."
    }
  }
}