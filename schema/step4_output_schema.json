{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Step 4 Output Schema",
  "description": "SimulationState after Step 4 â€” fully initialized, boundary-conditioned, and ready for the time loop.",
  "type": "object",

  "required": [
    "P_ext",
    "U_ext",
    "V_ext",
    "W_ext",
    "domain",
    "rhs_source",
    "bc_applied",
    "diagnostics",
    "history",
    "initialized",
    "ready_for_time_loop"
  ],

  "properties": {

    "P_ext": {
      "type": "array",
      "description": "Extended pressure field with ghost layers (3D float64 array)",
      "items": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }
    },

    "U_ext": {
      "type": "array",
      "description": "Extended U-velocity field on x-faces with ghost layers",
      "items": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }
    },

    "V_ext": {
      "type": "array",
      "description": "Extended V-velocity field on y-faces with ghost layers",
      "items": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }
    },

    "W_ext": {
      "type": "array",
      "description": "Extended W-velocity field on z-faces with ghost layers",
      "items": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }
    },

    "domain": {
      "type": "object",
      "description": "Domain metadata, coordinates, ghost layers, index ranges, and interpolation maps",

      "required": [
        "coordinates",
        "ghost_layers",
        "index_ranges",
        "stencil_maps",
        "interpolation_maps"
      ],

      "properties": {

        "coordinates": {
          "type": "object",
          "required": [
            "x_centers", "y_centers", "z_centers",
            "x_faces_u", "y_faces_v", "z_faces_w"
          ],
          "properties": {
            "x_centers": { "type": "array", "items": { "type": "number" } },
            "y_centers": { "type": "array", "items": { "type": "number" } },
            "z_centers": { "type": "array", "items": { "type": "number" } },
            "x_faces_u": { "type": "array", "items": { "type": "number" } },
            "y_faces_v": { "type": "array", "items": { "type": "number" } },
            "z_faces_w": { "type": "array", "items": { "type": "number" } }
          }
        },

        "ghost_layers": {
          "type": "object",
          "required": ["P_ext", "U_ext", "V_ext", "W_ext"],
          "properties": {
            "P_ext": { "type": "array" },
            "U_ext": { "type": "array" },
            "V_ext": { "type": "array" },
            "W_ext": { "type": "array" }
          }
        },

        "index_ranges": {
          "type": "object",
          "required": [
            "interior",
            "ghost_x_lo", "ghost_x_hi",
            "ghost_y_lo", "ghost_y_hi",
            "ghost_z_lo", "ghost_z_hi"
          ],
          "properties": {
            "interior": { "type": "string" },
            "ghost_x_lo": { "type": "string" },
            "ghost_x_hi": { "type": "string" },
            "ghost_y_lo": { "type": "string" },
            "ghost_y_hi": { "type": "string" },
            "ghost_z_lo": { "type": "string" },
            "ghost_z_hi": { "type": "string" }
          }
        },

        "stencil_maps": {
          "type": "object",
          "required": ["xp", "xm", "yp", "ym", "zp", "zm"],
          "properties": {
            "xp": { "type": "array" },
            "xm": { "type": "array" },
            "yp": { "type": "array" },
            "ym": { "type": "array" },
            "zp": { "type": "array" },
            "zm": { "type": "array" }
          }
        },

        "interpolation_maps": {
          "type": "object",
          "required": [
            "interp_u_to_v",
            "interp_u_to_w",
            "interp_v_to_u",
            "interp_v_to_w",
            "interp_w_to_u",
            "interp_w_to_v"
          ],
          "properties": {
            "interp_u_to_v": {},
            "interp_u_to_w": {},
            "interp_v_to_u": {},
            "interp_v_to_w": {},
            "interp_w_to_u": {},
            "interp_w_to_v": {}
          }
        }
      }
    },

    "rhs_source": {
      "type": "object",
      "required": ["fx_u", "fy_v", "fz_w"],
      "properties": {
        "fx_u": { "type": "array" },
        "fy_v": { "type": "array" },
        "fz_w": { "type": "array" }
      }
    },

    "bc_applied": {
      "type": "object",
      "required": [
        "initial_velocity_enforced",
        "pressure_initial_applied",
        "velocity_initial_applied",
        "ghost_cells_filled",
        "boundary_cells_checked",
        "boundary_conditions_status"
      ],
      "properties": {
        "initial_velocity_enforced": { "type": "boolean" },
        "pressure_initial_applied": { "type": "boolean" },
        "velocity_initial_applied": { "type": "boolean" },
        "ghost_cells_filled": { "type": "boolean" },
        "boundary_cells_checked": { "type": "integer" },

        "version": { "type": "string" },
        "timestamp_applied": { "type": "string" },

        "boundary_conditions_status": {
          "type": "object",
          "required": ["x_min", "x_max", "y_min", "y_max", "z_min", "z_max"],
          "properties": {
            "x_min": { "type": "string", "enum": ["applied", "skipped", "error"] },
            "x_max": { "type": "string", "enum": ["applied", "skipped", "error"] },
            "y_min": { "type": "string", "enum": ["applied", "skipped", "error"] },
            "y_max": { "type": "string", "enum": ["applied", "skipped", "error"] },
            "z_min": { "type": "string", "enum": ["applied", "skipped", "error"] },
            "z_max": { "type": "string", "enum": ["applied", "skipped", "error"] }
          }
        }
      }
    },

    "diagnostics": {
      "type": "object",
      "required": [
        "total_fluid_cells",
        "grid_volume_per_cell",
        "initialized",
        "post_bc_max_velocity",
        "post_bc_divergence_norm",
        "bc_violation_count"
      ],
      "properties": {
        "total_fluid_cells": { "type": "integer" },
        "grid_volume_per_cell": { "type": "number" },
        "initialized": { "type": "boolean" },
        "post_bc_max_velocity": { "type": "number" },
        "post_bc_divergence_norm": { "type": "number" },
        "bc_violation_count": { "type": "integer" }
      }
    },

    "history": {
      "type": ["object", "null"],
      "properties": {
        "times": { "type": "array", "items": { "type": "number" } },
        "diverggence_norms": { "type": "array", "items": { "type": "number" } },
        "max_velocity_history": { "type": "array", "items": { "type": "number" } },
        "ppe_iterations_history": { "type": "array", "items": { "type": "integer" } }
      }
    },

    "initialized": {
      "type": "boolean",
      "description": "True if Step 4 completed successfully"
    },

    "ready_for_time_loop": {
      "type": "boolean",
      "description": "True if the state is fully prepared for repeated projection steps"
    }
  }
}
