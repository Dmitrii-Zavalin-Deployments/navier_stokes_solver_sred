{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Step 1 Output Schema",
  "type": "object",

  "required": [
    "grid",
    "fields",
    "mask_3d",
    "boundary_table",
    "constants",
    "config"
  ],

  "properties": {

    "grid": {
      "type": "object",
      "required": [
        "x_min", "x_max",
        "y_min", "y_max",
        "z_min", "z_max",
        "nx", "ny", "nz",
        "dx", "dy", "dz"
      ],
      "properties": {
        "x_min": { "type": "number" },
        "x_max": { "type": "number" },
        "y_min": { "type": "number" },
        "y_max": { "type": "number" },
        "z_min": { "type": "number" },
        "z_max": { "type": "number" },

        "nx": { "type": "integer", "minimum": 1 },
        "ny": { "type": "integer", "minimum": 1 },
        "nz": { "type": "integer", "minimum": 1 },

        "dx": { "type": "number", "exclusiveMinimum": 0 },
        "dy": { "type": "number", "exclusiveMinimum": 0 },
        "dz": { "type": "number", "exclusiveMinimum": 0 }
      }
    },

    "fields": {
      "type": "object",
      "required": ["P", "U", "V", "W", "Mask"],
      "properties": {
        "P": {
          "type": "array",
          "items": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }
        },
        "U": {
          "type": "array",
          "items": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }
        },
        "V": {
          "type": "array",
          "items": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }
        },
        "W": {
          "type": "array",
          "items": { "type": "array", "items": { "type": "array", "items": { "type": "number" } } }
        },
        "Mask": {
          "type": "array",
          "items": {
            "type": "array",
            "items": {
              "type": "array",
              "items": { "type": "integer", "enum": [-1, 0, 1] }
            }
          }
        }
      }
    },

    "mask_3d": {
      "type": "array",
      "description": "3D geometry mask reconstructed from flattened input",
      "items": {
        "type": "array",
        "items": {
          "type": "array",
          "items": { "type": "integer", "enum": [-1, 0, 1] }
        }
      }
    },

    "boundary_table": {
      "type": "array",
      "description": "Normalized boundary condition table produced in Step 1"
    },

    "constants": {
      "type": "object",
      "required": [
        "rho", "mu", "dt",
        "dx", "dy", "dz",
        "inv_dx", "inv_dy", "inv_dz",
        "inv_dx2", "inv_dy2", "inv_dz2"
      ],
      "properties": {
        "rho": { "type": "number", "exclusiveMinimum": 0 },
        "mu": { "type": "number", "minimum": 0 },
        "dt": { "type": "number", "exclusiveMinimum": 0 },

        "dx": { "type": "number", "exclusiveMinimum": 0 },
        "dy": { "type": "number", "exclusiveMinimum": 0 },
        "dz": { "type": "number", "exclusiveMinimum": 0 },

        "inv_dx": { "type": "number" },
        "inv_dy": { "type": "number" },
        "inv_dz": { "type": "number" },

        "inv_dx2": { "type": "number" },
        "inv_dy2": { "type": "number" },
        "inv_dz2": { "type": "number" }
      }
    },

    "config": {
      "type": "object",
      "description": "Original validated input JSON passed through unchanged.",
      "properties": {
        "domain": { "type": "object" },
        "fluid": { "type": "object" },
        "simulation": { "type": "object" },
        "forces": { "type": "object" },
        "boundary_conditions": { "type": "object" },
        "geometry_definition": { "type": "object" }
      }
    }
  }
}